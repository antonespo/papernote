# CI Pipeline for Backend - Runs on every push
name: Backend CI

on:
  # Run on every push to any branch
  push:
    paths:
      - "backend/**"
      - ".github/workflows/backend-ci.yml"
      - "docker-compose*.yml"
  # Run on PRs to main
  pull_request:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/backend-ci.yml"
      - "docker-compose*.yml"

env:
  DOTNET_VERSION: "8.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-and-test:
    name: Build and Test .NET Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - Papernote.Auth.API
          - Papernote.Notes.API
          - Papernote.Gateway
          - Papernote.Shared

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore backend/Papernote/Papernote.sln

      - name: Build solution
        run: dotnet build backend/Papernote/Papernote.sln --no-restore --configuration Release

      - name: Run unit tests
        run: dotnet test backend/Papernote/Papernote.sln --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --filter Category!=Integration

      - name: Upload coverage reports
        if: matrix.service == 'Papernote.Auth.API'
        uses: codecov/codecov-action@v4
        with:
          files: "**/coverage.cobertura.xml"
          fail_ci_if_error: false

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore backend/Papernote/Papernote.sln

      - name: Run security scan
        run: dotnet list backend/Papernote package --vulnerable --include-transitive

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [build-and-test]

    strategy:
      matrix:
        service:
          - auth-service
          - notes-service
          - gateway

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/Papernote
          file: ./backend/Papernote/Papernote.${{ matrix.service == 'auth-service' && 'Auth.API' || matrix.service == 'notes-service' && 'Notes.API' || 'Gateway' }}/Dockerfile
          push: false
          tags: papernote-${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
