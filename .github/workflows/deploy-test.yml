name: Deploy Test Environment

on:
  workflow_dispatch:
  # push:
  #   branches: [main]
  #   paths:
  #     - "backend/**"
  #     - "frontend/**"
  #     - "docker/**"
  #     - ".github/workflows/deploy-test.yml"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          export GATEWAY_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gateway:${{ github.sha }}"
          export AUTH_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:${{ github.sha }}"
          export NOTES_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notes:${{ github.sha }}"
          export FRONTEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ github.sha }}"
          docker compose -f docker/compose.test.yml pull

      - run: |
          export GATEWAY_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gateway:${{ github.sha }}"
          export AUTH_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:${{ github.sha }}"
          export NOTES_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notes:${{ github.sha }}"
          export FRONTEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ github.sha }}"
          docker compose -f docker/compose.test.yml down -v || true
          docker compose -f docker/compose.test.yml up -d --wait --wait-timeout 300

      - run: |
          timeout 120 bash -c 'until curl -f http://localhost:5000/health; do sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:5001/health; do sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:5002/health; do sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:3000/; do sleep 5; done'

      - run: |
          echo "Test environment deployed successfully"
          echo "Gateway: http://localhost:5000"
          echo "Auth: http://localhost:5001"
          echo "Notes: http://localhost:5002"
          echo "Frontend: http://localhost:3000"
