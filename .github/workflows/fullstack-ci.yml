# CI Pipeline for Backend and Frontend - Runs on every push
name: Full Stack CI

on:
  # Run on every push to any branch
  push:
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/fullstack-ci.yml"
  # Run on PRs to main
  pull_request:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/fullstack-ci.yml"

env:
  DOTNET_VERSION: "8.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NODE_VERSION: "18.x"

jobs:
  frontend-build:
    name: Build Angular Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Angular app (production)
        run: |
          cd frontend
          npm run build

      - name: Build Angular app (docker config)
        run: |
          cd frontend
          npm run build -- --configuration docker

  backend-build:
    name: Build and Test .NET Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - Papernote.Auth.API
          - Papernote.Auth.Core
          - Papernote.Auth.Infrastructure
          - Papernote.Gateway
          - Papernote.Notes.API
          - Papernote.Notes.Core
          - Papernote.Notes.Infrastructure
          - Papernote.SharedMicroservices

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore backend/Papernote/Papernote.sln

      - name: Build solution
        run: dotnet build backend/Papernote/Papernote.sln --no-restore --configuration Release

      - name: Verify build artifacts
        run: |
          echo "Build completed successfully for ${{ matrix.service }}"
          ls -la backend/Papernote/${{ matrix.service }}/bin/Release/

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore backend/Papernote/Papernote.sln

      - name: Run security scan
        run: dotnet list backend/Papernote package --vulnerable --include-transitive

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]

    strategy:
      matrix:
        service:
          - auth-service
          - notes-service
          - gateway-service
          - frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker image
        if: matrix.service != 'frontend'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/Papernote
          file: ./backend/Papernote/Papernote.${{ matrix.service == 'auth-service' && 'Auth.API' || matrix.service == 'notes-service' && 'Notes.API' || 'Gateway' }}/Dockerfile
          push: false
          tags: papernote-${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend Docker image
        if: matrix.service == 'frontend'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: papernote-frontend:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
